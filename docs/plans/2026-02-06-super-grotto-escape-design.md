# Super Grotto Escape - 游戏设计文档

> **类型**: Roguelike地牢探索平台动作游戏
> **技术栈**: Phaser 3 + TypeScript + Vite
> **版本**: MVP v1.0
> **日期**: 2026-02-06

---

## 1. 游戏概述

### 1.1 核心玩法
玩家在随机生成的洞穴地牢中探索，击败敌人收集货币和升级。死亡后永久保留货币用于解锁新能力，然后重新挑战。

### 1.2 设计目标
- 快速可玩的MVP版本
- 房间拼接型关卡生成
- 近战+远程双系统战斗
- 货币解锁型永久进程

### 1.3 MVP范围
- 1个区域（洞穴）
- 3-5种房间模板
- 3种普通敌人 + 1个Boss
- 基础升级系统

---

## 2. 项目结构

```
super-grotto-escape/
├── src/
│   ├── scenes/               # Phaser场景
│   │   ├── BootScene.ts      # 资源预加载
│   │   ├── MenuScene.ts      # 主菜单
│   │   ├── GameScene.ts      # 核心游戏场景
│   │   ├── HubScene.ts       # 死亡后的升级商店
│   │   └── GameOverScene.ts  # 结算画面
│   ├── entities/             # 游戏实体
│   │   ├── Player.ts         # 玩家角色
│   │   ├── enemies/          # 敌人类
│   │   │   ├── Enemy.ts      # 敌人基类
│   │   │   ├── Slime.ts
│   │   │   ├── Bat.ts
│   │   │   ├── Skeleton.ts
│   │   │   └── GhostBoss.ts
│   │   └── pickups/          # 拾取物
│   │       ├── Coin.ts
│   │       ├── Crystal.ts
│   │       └── HealthDrop.ts
│   ├── systems/              # 游戏系统
│   │   ├── RoomManager.ts    # 房间加载/切换
│   │   ├── CombatSystem.ts   # 战斗逻辑
│   │   ├── ProgressManager.ts # 永久进程管理
│   │   └── InputManager.ts   # 输入处理
│   ├── ui/                   # UI组件
│   │   ├── HUD.ts            # 游戏内界面
│   │   ├── PauseMenu.ts      # 暂停菜单
│   │   └── UpgradeShop.ts    # 升级商店
│   ├── data/                 # 配置数据
│   │   ├── rooms/            # 房间模板JSON
│   │   ├── enemies.json      # 敌人配置
│   │   ├── weapons.json      # 武器配置
│   │   └── upgrades.json     # 升级配置
│   ├── utils/                # 工具函数
│   └── main.ts               # 入口文件
├── assets/                   # 游戏资源
│   ├── sprites/              # 精灵图
│   ├── tilemaps/             # Tiled地图
│   └── audio/                # 音效音乐
├── public/
├── index.html
├── package.json
├── tsconfig.json
└── vite.config.ts
```

### 2.1 技术依赖
- Phaser 3.60+
- TypeScript 5.x
- Vite 5.x（构建工具）

---

## 3. 场景流程与游戏循环

### 3.1 场景流转图
```
BootScene → MenuScene → GameScene ←→ HubScene
                ↑            ↓
                └── GameOverScene
```

### 3.2 核心游戏循环
1. 玩家进入房间 → 门关闭
2. 清除所有敌人 → 门开启，掉落奖励
3. 选择出口进入下一房间
4. 每5个房间遇到Boss房
5. 击败Boss → 进入下一区域或通关
6. 死亡 → 结算货币 → HubScene升级 → 重新开始

### 3.3 房间类型
| 房间类型 | 描述 | 出现频率 |
|----------|------|----------|
| 战斗房 | 3-5个敌人，必须清空才能继续 | 60% |
| 宝箱房 | 无敌人，获得武器/升级 | 15% |
| 商店房 | 消耗本局货币购买道具 | 10% |
| Boss房 | 每区域结尾的Boss战 | 固定 |
| 起始房 | 安全区，选择初始路线 | 固定 |

### 3.4 单局临时状态
- 当前生命值
- 当前武器
- 本局收集的升级效果
- 本局货币（水晶）

---

## 4. 玩家系统

### 4.1 移动能力
| 能力 | 描述 | 解锁状态 |
|------|------|----------|
| 行走 | 左右移动 | 默认 |
| 跳跃 | 单次跳跃 | 默认 |
| 下蹲 | 降低碰撞体积 | 默认 |
| 墙壁滑行 | 接触墙壁时减缓下落 | 默认 |
| 边缘攀爬 | 抓住平台边缘爬上 | 默认 |
| 滑铲 | 快速滑行并穿过敌人 | 默认 |
| 二段跳 | 空中额外跳跃一次 | 解锁 |

### 4.2 战斗系统
```typescript
interface WeaponSlots {
  primary: MeleeWeapon;    // 近战：剑/锤 - 高伤害、短距离、可连击
  secondary: RangedWeapon; // 远程：枪/弓 - 中伤害、需弹药或冷却
  skill: SpecialSkill;     // 技能：冲刺攻击/护盾/范围攻击 - 冷却时间
}
```

### 4.3 玩家属性
| 属性 | 基础值 | 说明 |
|------|--------|------|
| 生命值 | 100 | 可通过升级提高上限 |
| 攻击力 | 10 | 受武器和升级加成 |
| 移动速度 | 200 px/s | 可被升级提升 |
| 无敌帧 | 0.5s | 受击后无敌时间 |

### 4.4 操作映射
| 操作 | 键位 |
|------|------|
| 移动 | WASD / 方向键 |
| 近战攻击 | J / Z |
| 远程攻击 | K / X |
| 技能 | L / C |
| 跳跃 | Space |
| 滑铲/闪避 | Shift |
| 暂停 | ESC |

---

## 5. 敌人系统

### 5.1 MVP敌人配置
| 敌人 | 类型 | 行为模式 | HP | 伤害 | 金币掉落 |
|------|------|----------|-----|------|----------|
| Slime | 地面 | 巡逻，接近时跳跃冲撞 | 30 | 10 | 5-10 |
| Bat | 飞行 | 悬停，发现玩家后俯冲 | 20 | 15 | 8-12 |
| Skeleton | 地面 | 巡逻+远程投掷，近身挥砍 | 50 | 20 | 15-25 |
| Ghost (Boss) | 飞行 | 三阶段：追踪→冲刺→召唤 | 300 | 25 | 100-150 |

### 5.2 敌人AI状态机
```
Idle → Patrol → Chase → Attack → Cooldown
  ↑__________________________________|
```

### 5.3 掉落系统
- **普通敌人**: 金币（100%）、血瓶（20%概率）
- **Boss**: 大量金币 + 必掉武器/技能升级

### 5.4 难度缩放
- 房间深度每+1，敌人数量+10%
- 每过一个Boss，敌人生命值+20%

---

## 6. 关卡生成系统

### 6.1 房间模板规格
- 使用Tiled编辑器创建
- 固定尺寸：20x12瓦片（320x192像素）
- 瓦片大小：16x16像素
- 4个出口位置：上、下、左、右（可选启用）

### 6.2 房间拼接算法
```typescript
function generateLevel(): RoomGraph {
  // 1. 生成房间图（有向图）
  // 起点 → 3-4个战斗房 → Boss房
  // 分支：1个宝箱房、1个商店房（可选路径）

  // 2. 连接规则
  // 左出口 → 右入口
  // 下出口 → 上入口
  // 确保无死路（除终点外）

  // 3. 敌人放置
  // 读取房间模板中的spawn点
  // 根据房间深度随机选择敌人类型和数量
}
```

### 6.3 房间切换流程
1. 玩家触碰出口门
2. 淡出过渡动画（0.3s）
3. 加载新房间Tilemap
4. 放置敌人和道具
5. 淡入动画（0.3s）
6. 玩家从对应入口出现

### 6.4 Tilemap图层结构
| 图层 | 用途 |
|------|------|
| Background | 背景装饰（无碰撞） |
| Terrain | 碰撞地形 |
| Foreground | 前景装饰（在玩家前面） |
| Objects | 敌人spawn点、道具点、出口门 |

---

## 7. 永久进程与升级系统

### 7.1 货币系统
| 货币 | 获取方式 | 持久性 | 用途 |
|------|----------|--------|------|
| 金币 | 击杀敌人 | 永久保留 | Hub商店升级 |
| 水晶 | 房间拾取 | 仅当局有效 | 商店房购买 |

### 7.2 永久升级表（HubScene）
| 升级项 | 等级 | 效果 | 解锁费用 |
|--------|------|------|----------|
| 生命提升 | I | 最大生命值+20 | 100 |
| 生命提升 | II | 最大生命值+40 | 300 |
| 生命提升 | III | 最大生命值+60 | 600 |
| 攻击提升 | I | 攻击力+15% | 150 |
| 攻击提升 | II | 攻击力+30% | 400 |
| 攻击提升 | III | 攻击力+50% | 800 |
| 二段跳 | - | 解锁空中二段跳 | 400 |
| 初始武器 | - | 开局可选新武器 | 500 |
| 金币加成 | - | 金币掉落+25% | 350 |

### 7.3 本局临时升级（战斗房/宝箱房获得）
- 攻击速度提升 +20%
- 吸血效果 10%
- 弹幕数量 +1
- 移动速度 +15%
- 护盾（额外25HP）

### 7.4 数据持久化
```typescript
interface SaveData {
  coins: number;              // 金币数量
  unlocks: string[];          // 已解锁升级ID
  stats: {
    totalRuns: number;        // 总局数
    bestDepth: number;        // 最深房间
    bossKills: number;        // Boss击杀数
  };
}
// 使用 localStorage 存储
```

---

## 8. UI系统

### 8.1 游戏内HUD布局
```
┌─────────────────────────────────────────┐
│ [♥♥♥♥♥ 80/100]    [金币:123] [水晶:45] │
│                                         │
│                                         │
│            (游戏区域 320x192)            │
│                                         │
│                                         │
│ [剑图标]  [枪图标]  [技能 CD:3s]         │
└─────────────────────────────────────────┘
```

### 8.2 UI场景职责
| 场景 | 内容 |
|------|------|
| MenuScene | 开始游戏、设置、退出 |
| HubScene | 升级商店、角色状态、开始新局 |
| GameOverScene | 本局统计、获得金币、返回Hub |

### 8.3 暂停菜单
- 继续游戏
- 设置（音量、按键绑定）
- 放弃本局（返回Hub，保留金币）

---

## 9. 视觉与音效

### 9.1 视觉反馈
| 事件 | 反馈效果 |
|------|----------|
| 玩家受击 | 屏幕闪红 + 角色闪烁 |
| 暴击 | 伤害数字放大 + 特殊颜色 |
| 敌人死亡 | 粒子特效 + 掉落物弹出 |
| 房间清空 | 门开启音效 + 光效 |
| 升级获得 | 全屏光效 + 文字提示 |

### 9.2 音效规划（后期添加）
| 类别 | 音效 |
|------|------|
| 动作 | 攻击、受击、跳跃、滑铲 |
| 系统 | 拾取、房间清空、Boss出现 |
| BGM | 战斗曲、商店曲、Hub曲 |

---

## 10. 资源清单

### 10.1 来自 Super Grotto Escape Files
| 资源类型 | 路径 | 用途 |
|----------|------|------|
| 玩家精灵 | Assets/Characters/Player/ | 13种动作动画 |
| Slime | Assets/Characters/Enemies/Slime/ | 敌人动画 |
| Bat | Assets/Characters/Enemies/Bat/ | 敌人动画 |
| Skeleton | Assets/Characters/Enemies/Skeleton/ | 敌人动画 |
| Ghost | Assets/Characters/Enemies/Ghost/ | Boss动画 |
| Tileset | Assets/Environment/Layers/tileset.png | 关卡地形 |
| 背景图层 | Assets/Environment/Layers/*.png | 视差背景 |
| 道具 | Assets/Props/Sprites/ | 装饰和交互物 |
| 特效 | Assets/Fx/ | 粒子和光效 |

### 10.2 需要制作的资源
- UI元素（按钮、面板、图标）
- 武器图标
- 升级图标
- 字体

---

## 11. 开发里程碑

### Phase 1: 基础框架
- [ ] 项目初始化（Vite + Phaser + TypeScript）
- [ ] 场景框架搭建
- [ ] 资源加载系统

### Phase 2: 核心玩法
- [ ] 玩家移动和动画
- [ ] 基础战斗系统
- [ ] 单个房间原型

### Phase 3: 敌人和关卡
- [ ] 3种敌人AI
- [ ] 房间模板制作（Tiled）
- [ ] 房间拼接系统

### Phase 4: 进程系统
- [ ] 货币和掉落
- [ ] 永久升级商店
- [ ] 数据持久化

### Phase 5: Boss和完善
- [ ] Ghost Boss战
- [ ] UI完善
- [ ] 平衡性调整

### Phase 6: 打磨
- [ ] 音效集成
- [ ] 视觉特效
- [ ] Bug修复和优化

---

## 附录

### A. 参考游戏
- Dead Cells（死亡细胞）- 战斗手感、永久进程
- Enter the Gungeon（挺进地牢）- 房间生成、射击系统
- Hades（哈迪斯）- 双武器系统、叙事整合

### B. 技术参考
- Phaser 3 官方文档
- Tiled Map Editor
- TypeScript 手册
